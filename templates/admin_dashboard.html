<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üßô‚Äç‚ôÄÔ∏è –ê–¥–º–∏–Ω–∫–∞ ‚Äî –í–µ–¥—å–º—ã –Ω–µ —Å—Ç–∞—Ä–µ—é—Ç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 {
            font-size: 1.6rem;
            background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logout {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,107,107,0.8);
            background: rgba(255,107,107,0.18);
            color: #ff9a9a;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            gap: 14px;
            border-bottom: 1px solid rgba(168,237,234,0.35);
            margin-bottom: 16px;
        }
        .tab-btn {
            padding: 9px 16px;
            border: none;
            background: transparent;
            color: #b19cd9;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 0.95rem;
        }
        .tab-btn.active {
            color: #a8edea;
            border-bottom-color: #a8edea;
        }
        .tab {
            display: none;
            margin-top: 16px;
        }
        .tab.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }
        .stat-card {
            padding: 16px;
            border-radius: 14px;
            border: 2px solid rgba(168,237,234,0.35);
            background: linear-gradient(135deg, rgba(168,237,234,0.08), rgba(254,214,227,0.08));
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            color: #a8edea;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #b19cd9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            border-radius: 14px;
            overflow: hidden;
            border: 2px solid rgba(168,237,234,0.35);
            background: linear-gradient(135deg, rgba(168,237,234,0.08), rgba(254,214,227,0.08));
            font-size: 0.9rem;
        }
        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(168,237,234,0.15);
        }
        th {
            text-align: left;
            background: rgba(168,237,234,0.15);
            color: #a8edea;
            font-weight: 600;
        }
        tr:hover td {
            background: rgba(168,237,234,0.06);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pending { background: rgba(255,193,7,0.15); color: #ffcf4a; }
        .status-approved { background: rgba(76,175,80,0.18); color: #7cd67c; }
        .status-rejected { background: rgba(244,67,54,0.18); color: #ff9a9a; }

        .btn-xs {
            padding: 5px 8px;
            border-radius: 7px;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-approve { background: rgba(76,175,80,0.2); color: #7cd67c; border: 1px solid rgba(76,175,80,0.7); }
        .btn-reject { background: rgba(244,67,54,0.2); color: #ff9a9a; border: 1px solid rgba(244,67,54,0.7); }
        .btn-add-member { background: rgba(168,237,234,0.2); color: #a8edea; border: 1px solid rgba(168,237,234,0.85); }
        .btn-delete { background: rgba(255,107,107,0.15); color: #ffb3b3; border: 1px solid rgba(255,107,107,0.7); }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 14px;
            margin-top: 8px;
        }
        .member-card {
            padding: 14px;
            border-radius: 14px;
            border: 2px solid rgba(168,237,234,0.35);
            background: linear-gradient(135deg, rgba(168,237,234,0.08), rgba(254,214,227,0.08));
        }
        .member-emoji { font-size: 2rem; margin-bottom: 4px; }
        .member-name { font-weight: 700; margin-bottom: 2px; }
        .member-title { font-size: 0.85rem; color: #fed6e3; margin-bottom: 6px; }
        .empty {
            margin-top: 20px;
            text-align: center;
            color: #b19cd9;
            font-size: 0.9rem;
        }
        @media (max-width: 720px) {
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .tabs { flex-wrap: wrap; }
            table { font-size: 0.8rem; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>üßô‚Äç‚ôÄÔ∏è –ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å –∫–ª—É–±–∞ ¬´–í–µ–¥—å–º—ã –Ω–µ —Å—Ç–∞—Ä–µ—é—Ç¬ª</h1>
        <button class="logout" id="logoutBtn">–í—ã–π—Ç–∏</button>
    </header>

    <div class="tabs">
        <button class="tab-btn active" data-tab="tab-dashboard">üìä –î–∞—à–±–æ—Ä–¥</button>
        <button class="tab-btn" data-tab="tab-apps">üìù –ó–∞—è–≤–∫–∏</button>
        <button class="tab-btn" data-tab="tab-members">üë• –£—á–∞—Å—Ç–Ω–∏—Ü—ã</button>
    </div>

    <!-- –î–∞—à–±–æ—Ä–¥ -->
    <section id="tab-dashboard" class="tab active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="statTotal">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statPending">0</div>
                <div class="stat-label">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statApproved">0</div>
                <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statRejected">0</div>
                <div class="stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statMembers">0</div>
                <div class="stat-label">–£—á–∞—Å—Ç–Ω–∏—Ü –∫–ª—É–±–∞</div>
            </div>
        </div>
    </section>

    <!-- –ó–∞—è–≤–∫–∏ -->
    <section id="tab-apps" class="tab">
        <table>
            <thead>
            <tr>
                <th>–ò–º—è</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–∞—Ç–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody id="appsBody">
            <tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
    </section>

    <!-- –£—á–∞—Å—Ç–Ω–∏—Ü—ã -->
    <section id="tab-members" class="tab">
        <div id="membersGrid" class="members-grid"></div>
        <div id="membersEmpty" class="empty" style="display:none;">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏—Ü</div>
    </section>
</div>

<script>
    const API_URL = '/api';

    // –∑–∞—â–∏—Ç–∞ –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ñ–ª–∞–∂–∫—É
    if (!localStorage.getItem('witch_admin_auth')) {
        window.location.href = '/admin_login.html';
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('witch_admin_auth');
        window.location.href = '/';
    });

    // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab).classList.add('active');
        });
    });

    // –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ —Ç–∏—Ç—É–ª–∞
    function randomTitle(name) {
        const bases = [
            '–í–µ–¥—å–º–∞ –õ—É–Ω–Ω–æ–≥–æ –°–≤–µ—Ç–∞',
            '–•—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –¢–µ–Ω–µ–π',
            '–ß–∞—Ä–æ–¥–µ–π–∫–∞ –£—Ç—Ä–µ–Ω–Ω–∏—Ö –¢—É–º–∞–Ω–æ–≤',
            '–í–µ–¥–∞—é—â–∞—è –ü—É—Ç—è–º–∏ –°—É–¥—å–±—ã',
            '–ú–∞–≥–∏–Ω—è –ó–≤—ë–∑–¥–Ω–æ–≥–æ –í–µ—Ç—Ä–∞',
            '–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –ß–∞—è –∏ –¢–∞—Ä–æ',
            '–ë–µ—Ä–µ–≥–∏–Ω—è –¢–∏—à–∏–Ω—ã',
            '–ß—Ç–∏—Ü–∞ –õ–∏–Ω–∏–π –í—Ä–µ–º–µ–Ω–∏'
        ];
        const idx = Math.floor(Math.random() * bases.length);
        return bases[idx];
    }
    function randomEmoji() {
        const list = ['üîÆ','üåô','üßø','‚ú®','üïØÔ∏è','ü¶Ç','üåë','üïäÔ∏è','üßô‚Äç‚ôÄÔ∏è','üå∏'];
        return list[Math.floor(Math.random() * list.length)];
    }

    async function fetchJSON(url, options) {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
    }

    async function loadDashboard() {
        try {
            const apps = await fetchJSON(API_URL + '/applications');
            const members = await fetchJSON(API_URL + '/members');
            const arr = apps.applications || [];
            const total = arr.length;
            const pending = arr.filter(a => a.status === 'pending').length;
            const approved = arr.filter(a => a.status === 'approved').length;
            const rejected = arr.filter(a => a.status === 'rejected').length;
            const membersCount = (members.members || []).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statApproved').textContent = approved;
            document.getElementById('statRejected').textContent = rejected;
            document.getElementById('statMembers').textContent = membersCount;
        } catch (e) {
            console.error(e);
        }
    }

    async function loadApplications() {
        const body = document.getElementById('appsBody');
        body.innerHTML = '<tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
        try {
            const data = await fetchJSON(API_URL + '/applications');
            const apps = data.applications || [];
            if (!apps.length) {
                body.innerHTML = '<tr><td colspan="4">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>';
                return;
            }
            body.innerHTML = apps.map(app => {
                const statusClass =
                    app.status === 'approved' ? 'status-approved' :
                    app.status === 'rejected' ? 'status-rejected' :
                    'status-pending';
                const statusText =
                    app.status === 'approved' ? '–û–¥–æ–±—Ä–µ–Ω–∞' :
                    app.status === 'rejected' ? '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞' :
                    '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ';
                const date = app.createdAt
                    ? new Date(app.createdAt).toLocaleDateString('ru-RU')
                    : '‚Äî';

                return `
                    <tr>
                        <td>${app.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${date}</td>
                        <td>
                            <div class="actions">
                                ${app.status === 'pending' ? `
                                <button class="btn-xs btn-approve" onclick="approveApp('${app.id}')">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
                                <button class="btn-xs btn-reject" onclick="rejectApp('${app.id}')">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                ` : ''}
                                <button class="btn-xs btn-add-member" onclick="addFromApp('${app.id}')">‚ûï –í —É—á–∞—Å—Ç–Ω–∏—Ü—ã</button>
                                <button class="btn-xs btn-delete" onclick="deleteApp('${app.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        } catch (e) {
            console.error(e);
            body.innerHTML = '<tr><td colspan="4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        }
    }

    async function loadMembers() {
        const grid = document.getElementById('membersGrid');
        const empty = document.getElementById('membersEmpty');
        grid.innerHTML = '';
        empty.style.display = 'none';
        try {
            const data = await fetchJSON(API_URL + '/members');
            const members = data.members || [];
            if (!members.length) {
                empty.style.display = 'block';
                return;
            }
            grid.innerHTML = members.map(m => `
                <div class="member-card">
                    <div class="member-emoji">${m.emoji || 'üîÆ'}</div>
                    <div class="member-name">${m.name}</div>
                    <div class="member-title">${m.title || ''}</div>
                    <button class="btn-xs btn-delete" style="margin-top:8px;width:100%;" onclick="deleteMember('${m.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        } catch (e) {
            console.error(e);
            empty.style.display = 'block';
            empty.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
    }

    // –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –∑–∞—è–≤–∫–∞–º
    async function approveApp(id) {
        if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
        try {
            await fetchJSON(`${API_URL}/applications/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'approved' })
            });
            loadApplications();
            loadDashboard();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏');
        }
    }

    async function rejectApp(id) {
        if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
        try {
            await fetchJSON(`${API_URL}/applications/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'rejected' })
            });
            loadApplications();
            loadDashboard();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏');
        }
    }

    async function deleteApp(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
        try {
            await fetch(`${API_URL}/applications/${id}`, { method: 'DELETE' });
            loadApplications();
            loadDashboard();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
    }

    // –¥–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏—Ü—É –∏–∑ –∑–∞—è–≤–∫–∏
    async function addFromApp(id) {
        try {
            const data = await fetchJSON(API_URL + '/applications');
            const app = (data.applications || []).find(a => String(a.id) === String(id));
            if (!app) {
                alert('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            const title = randomTitle(app.name || '');
            const emoji = randomEmoji();

            await fetchJSON(API_URL + '/members', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: app.name || '–ë–µ–∑ –∏–º–µ–Ω–∏',
                    title,
                    emoji
                })
            });

            await fetchJSON(`${API_URL}/applications/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'approved' })
            });

            alert('–£—á–∞—Å—Ç–Ω–∏—Ü–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–ª—É–± ‚ú®');
            loadMembers();
            loadApplications();
            loadDashboard();
        } catch (e) {
            console.error(e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏—Ü—ã');
        }
    }

    // —É—á–∞—Å—Ç–Ω–∏—Ü—ã
    async function deleteMember(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏—Ü—É?')) return;
        try {
            await fetch(`${API_URL}/members/${id}`, { method: 'DELETE' });
            loadMembers();
            loadDashboard();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏—Ü—ã');
        }
    }

    // –≥–ª–æ–±–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ onclick –∏–∑ —à–∞–±–ª–æ–Ω–∞
    window.approveApp = approveApp;
    window.rejectApp = rejectApp;
    window.deleteApp = deleteApp;
    window.addFromApp = addFromApp;
    window.deleteMember = deleteMember;

    // —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏
    loadDashboard();
    loadApplications();
    loadMembers();
</script>
</body>
</html>
